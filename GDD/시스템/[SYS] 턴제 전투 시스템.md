---
title: 턴제 전투 시스템
category: 시스템
parent: [[GDD/[IDX] 인덱스]]
related:
  - [[GDD/시스템/[SYS] 부대 정비]]
  - [[GDD/시스템/[SYS] 상태 지속]]
  - [[GDD/데이터/[DATA] 데이터 모델 가이드]]
---

## 상위/연관
- 상위: [[GDD/[IDX] 인덱스]]  
- 연관: [[GDD/시스템/[SYS] 부대 정비]] · [[GDD/시스템/[SYS] 상태 지속]] · [[GDD/데이터/[DATA] 데이터 모델 가이드]]

---

## 개요 / 인덱스
- 상위 개요: [[GDD/시스템/[SYS] 전투 - 개요]]
- 세부 모듈:
  - [[GDD/시스템/[SYS] 전투 - 턴과 행동]]
  - [[GDD/시스템/[SYS] 전투 - 타겟팅과 범위]]
  - [[GDD/시스템/[SYS] 전투 - 공격 속성과 패시브]]
  - [[GDD/시스템/[SYS] 전투 - UI]]
  - [[GDD/시스템/[SYS] 전투 - 데이터와 수치]]

## 턴/행동 시스템(프로토 타입)
- 턴 큐: SPD 내림차순으로 초기 큐 생성, 행동 후 큐 뒤로 이동.  
- 현재 턴 유닛을 HUD에 강조 표시.  
- 명중: 스킬 `acc` 확률(0~1).  
- 피해: `max(1, round(공격자 atk × coeff − 방어자 def))`.  
- 멀티히트: `hits`만큼 반복, 중간에 대상 사망 시 중단.  
- 자원: MP 소비는 비용만 차감(효과 확장은 차후).

### 턴 시작 효과(DoT/HoT)
- UI가 새로운 `turnUnit`을 표시하는 순간 턴 시작 효과를 즉시 적용한다.
- 재생(Heal over Time): 적용 유닛의 HP를 회복하고 남은 턴을 1 감소.
- 중독(Poison DoT): 적용 유닛의 HP에서 최대 HP 기준 비율의 고정 피해를 적용하고 남은 턴을 1 감소. HP≤0이면 즉시 사망 처리.

## UI(프로토 타입)
- 상단: 턴 큐(다음 10명), 전투 식별자, 시드.  
- 중앙: 아군/적군 라인업, HP 바/활성 테두리.  
- 하단: 현재 턴 유닛 패널 + 스킬 버튼(일반 공격, 마구 베기, 화살 등).  
- 배치: 고정 랭크 슬롯(1~5). 아군: rank1(전방) 우측, rank5(후방) 좌측. 적군: rank1(전방) 좌측, rank5(후방) 우측.
- 타겟 선택: 아군 턴 시 적 유닛 카드 클릭으로 대상 지정(스킬 to 랭크 제약 준수).
- 툴팁: "앞열 타격\n명중률: 70%\n피해: 100% x 3회" 형식.
- 승리/패배: 모달 창 표시(결과 텍스트 + 루트로 버튼).

### 레이아웃(개편)
- 좌/우 패널 분리: 좌측=아군, 우측=적군. 패널 헤더와 색상 틴트로 시각 구분.  
- 행 구조: 각 측 3대열(후열·중열·전열) × 3칸 = 최대 9명.  
- 위치 매핑: `position 1~3=후열`, `4~6=중열`, `7~9=전열`. 칸이 부족하면 좌→우 순으로 채우기.  
- 슬롯 UI: 초상+HP 바만 노출, 현재 턴 `.is-turn`, 선택 타겟 `.is-target`, 선택 가능 대상 `.is-eligible`.  
- 시각 톤: 아군 패널은 청색 틴트, 적군 패널은 붉은 틴트. 선택 가능 대상(적)은 붉은 테두리 하이라이트.
- 하단 HUD: 현재 턴 유닛 이름, HP/MP, 버프/디버프 6칸.  
- 슬롯 아이콘: 지속효과(버프/디버프)가 적용된 유닛은 카드 우측 상단에 아이콘으로 표시하며, 아이콘 우측 하단에 남은 턴수를 숫자로 표시한다. 예) 지속 회복(✚, 남은 턴수).  
- 실드 게이지: 값이 0일 때는 표시하지 않고, 1 이상일 때만 표시한다.
- 행동 카드: 일반/특수/지원/방어, 정보/보정/MP 표기; 선택 시 `.selected` 하이라이트.  
  - 사용 불가(타겟 미충족/사거리 불일치/MP 부족 등) 카드는 `.disabled`로 반투명 처리되지만 선택은 가능.  
  - 사용 불가 카드에 커서를 올리면 사유 툴팁을 노출(예: "[후열 유닛만 선택 가능합니다]").  
  - 카드 정렬은 "사용 가능" → "사용 불가" 순서로 정렬해 가독성 확보.  
  - 타겟 변경 시: 현재 선택 카드가 새 타겟에 유효하면 선택 유지 및 [결정] 활성화, 유효하지 않으면 선택은 유지하되 [결정]은 비활성화.  
  - [결정] 버튼 활성 조건: 선택된 카드가 현재 타겟에 사용 가능하고, MP가 충분할 때.  
- 스킬 사용 UX(개편):
  - 스킬 카드는 선택 시 `.selected` 상태가 되며, 해당 카드에 마우스를 올리면 "한번 더 클릭 시 스킬 사용" 툴팁을 노출한다.
  - `.selected` 상태에서 같은 카드를 한 번 더 클릭하면 즉시 스킬을 사용한다.
  - [결정] 버튼은 제거한다.

### 동료 획득 및 기본 자동 배치(신규)
- 동료 획득 시 `ownedUnits[unitId]=true`로 보유 처리한다.
- 기본 자동 배치 규칙:
  - 유닛 데이터의 `preferredRows` 배열(예: `[3,2,1]`)을 순서대로 검사하여 빈 슬롯이 있으면 해당 행 첫 빈 칸에 배치한다.
  - `preferredRows`가 없으면 `[3,2,1]`(후열→중열→전열) 기본값을 사용한다.
  - 모든 슬롯이 가득 찬 경우 자동 배치하지 않는다.
  - 예: 동료A(`C-014`)는 `preferredRows:[3,2,1]`를 갖는다.

### 즉시 사망 규칙 및 연출
- 즉시 사망: 피해가 적용되어 HP≤0이 되는 순간 해당 유닛을 즉시 제거한다(턴 종료 대기 없음).
- 로그/연출: `hit` 이벤트 직후 `dead` 이벤트를 발생시키고, UI는 붉은 플래시와 붉은 이펙트를 표기한 뒤 슬롯에서 제거한다.
 - 상태 틱(예: 중독)으로 HP≤0이 되어도 동일하게 `dead` 이벤트가 즉시 발생한다.

## 스킬과 타겟 규칙(개편: 근접/원거리)
- 스킬은 `range`로 분류한다: `melee`(근접), `ranged`(원거리)
- **근접(melee)**: 적이 존재하는 열 중 가장 앞열의 적만 대상이 될 수 있다(앞열 전멸 시 자동으로 다음 열이 앞열로 간주)
- **원거리(ranged)**: 배치와 관계없이 모든 적을 대상으로 지정할 수 있다
- 기존 `from/to` 기반 제약은 참조용으로 유지하되, 우선순위는 `range` 규칙을 따른다

### 범위 스킬(라인/전열)
- 일도양단(주인공): 전열(row=1) 전체 타격, MP 5, acc 90%, coeff 95%, hits 1. to=[1]
- 관통샷(궁수): 선택 라인 전체(row=1/2/3) 타격, MP 3, acc 85%, coeff 90%, hits 1. to=[1,2,3] 중 현재 타겟 라인 적용
  - 관통샷은 `range:ranged`로, 임의 적을 선택하면 그 열 전체가 피해를 받는다

### 공격 속성 시스템(신규)
- 목적: 스킬별 피해 속성으로 대상의 패시브/특성에 따른 상호작용을 정의한다.
- 속성 목록(현재):
  - 참격(slash)
  - 관통(pierce)
  - 타격(blunt)
  - 마법(magic)
- 스킬 ↔ 속성 매핑(현재 정의):
  - 베기(SK-01) → 참격
  - 일도양단(SK-11) → 참격
  - 활쏘기(SK-02) → 관통
  - 관통샷(SK-12) → 관통
  - 검면치기(SK-31) → 타격
  - 마력탄(SK-30) → 마법
- 판정 영향: 속성은 명중/피해/저항/회피 등 계산에 보정치를 줄 수 있다. 예시:
  - 패시브 [뼈 골격]: 대상이 보유 시, 관통(pierce) 속성 공격에 대해 명중률 70% 추가 감소(예: acc × 0.30 적용).
- UI 반영:
  - 스킬 카드 통계 영역에 "속성: 참격/관통/타격/마법" 표기.
  - 예상 적중률/히트 배지는 속성-패시브 보정(예: 뼈 골격에 의한 관통 명중률 감소)을 반영하여 계산/표시한다.

### 신규 스킬: 독화살(SK-22)
- 유형: `range:ranged`, `type:poison`, `acc:0.85`, `cost: MP 3`
- 효과: 즉시 피해(공격력 × 60%) 후 대상에게 중독 부여(기본 3턴, 매 대상 턴 시작 시 최대 HP의 10% 고정 피해)
- 중첩: 재적용 시 남은 턴/수치 갱신(가산 중첩 없음)

## 상태/이상 효과
- 출혈/중독/기절/감속/도발/은신/가드 등.  
- 지속 효과는 라운드 종료 시 처리, 중첩 규칙 명시.
 - 중독은 예외적으로 대상의 턴 시작 시에 틱이 발생한다(고정 피해, 사망 가능).

## 수치와 공식(초안)
- 공격력(atk), 체력(HP), 마력(MP), 실드(shield=임시 체력), 방어력(def), 속도(SPD), 치명확률(crit), 회피확률(dodge), 막기확률(block)
- 판정 순서(단일 히트 기준):
  1) 명중 판정(acc)
  2) 회피 판정(dodge) → 성공 시 MISS
  3) 막기 판정(block) → 성공 시 피해 20%만 적용
  4) 치명타 판정(crit) → 성공 시 피해 ×1.5
  5) 피해 계산: `max(1, round(atk × coeff − def))` → 막기/치명 반영
  6) 실드로 피해 흡수 → 남은 피해만 HP 차감(실드 우선)
- 자원: HP/MP/스트레스를 기본 자원으로 사용, 스킬은 MP/소모품을 소비 가능.  
- 난수: 시드 고정. 동일 시나리오/설정에서 결과 재현 가능.

## 승패/이탈
- 전원 전투불능 시 패배. 적 전원 제압 시 승리.  
- 도주/퇴각 없음. 일부 루트는 승리 필수로 설정.

## 보상과 전투 후 처리
- 전투 보상 지급(골드/소모품/아이템).  
- HP/부상/일부 상태는 전투 후 유지(상세는 [[GDD/시스템/[SYS] 상태 지속]] 참조).

## UI
- 좌: 아군 초상/HP/버프/디버프, 우: 적 UI 동일.  
- 하단: 스킬 바(슬롯 4), 소모품 슬롯, 턴 순서 표시.  
- 로그/전투 기록 창.
 - 타겟팅: 아군 턴에 적 유닛 클릭 시 대상 지정(기본은 전열 우선 자동 선택).  
 - 툴팁: 스킬 Hover 시 명중률/히트수/계수/대상 랭크 표시.  

## 데이터 키(요약)
```json
{
  "unit": {"id": "C-001", "hp": 28, "mp": 10, "stress": 0, "spd": 7, "position": 2, "skills": ["SK-01","SK-02"]},
  "skill": {"id": "SK-01", "from": [1,2], "to": [1,2], "coeff": 1.2, "effects": ["bleed"]},
  "battle": {"round": 1, "turnQueue": ["C-001","E-101"], "seed": 12345, "field": {"ally":["C-001",null,null,null,null], "enemy":["E-101","E-102",null,null,null,null,null,null,null,null]}}
}
```

## 검증 항목
- 위치 제약 불일치 스킬 사용 불가  
- 차단/가드/은신 상호작용 우선순위 정의  
- 속도 동일 시 동률 규칙(동전던지기/고정 시드)
- 아군 중복 편성 금지(유니크 캐릭터 제약)

## 구조/모듈
- 상태: `src/state.js`  
- 데이터: `src/temp/data.js`  
- 엔진: `src/engine/rules.js`, `src/engine/battleCore.js`  
- UI: `src/views/ui/tooltip.js`  
- 뷰: `src/views/battle.js`, `src/views/routes.js`, `src/views/party.js`, `src/views/episode.js`
